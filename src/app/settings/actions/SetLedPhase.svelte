<script>
  import { onMount } from 'svelte';

  import { GRID_PROTOCOL } from '../../serialport/GridProtocol.js';

  import { serialComm } from '../../serialport/serialport.store';

  import { configStore } from '../../stores/config.store';

  import ColorPicker from '../ColorPicker.svelte';

  import DropDownInput from '../DropDownInput.svelte';

  export let data;
  export let orderNumber;
  export let selectedElementSettings;
  export let moduleInfo;
  export let eventInfo;

  function sendData(){

    //data.valid = setLedColorValidator(data.parameters);

    data.parameters[1] = layers;
    
    let parameterArray = [];
    for (let i = 0; i < data.parameters[1].length; i++) {
      let param_0;
      console.log(data.parameters[0]);
      if(data.parameters[0] != 'A0' && data.parameters[0] != 'A1'){ param_0 = Number(data.parameters[0]) } else { param_0 = data.parameters[0]}
      const parameters = [
        { 'NUM': param_0 },
        { 'LAY': data.parameters[1][i] },
        { 'PHA': Math.floor(data.parameters[2]) },
      ];
      parameterArray.push(parameters);
    }

    let serialized = [];
    parameterArray.forEach(parameters => {
      serialized.push(GRID_PROTOCOL.configure("LEDPHASE", parameters));
    });

    configStore.save(orderNumber, moduleInfo, eventInfo, selectedElementSettings, serialized);
  }

  let layers = data.parameters[1];

  let startColor;
  let alpha = 1;
  let parameters = [
    [
      {value: 'A0', info: 'This LED.'}, 
      {value: 'A1', info: 'Reversed LED.'}, 
    ],
    [
      {value: 'A3', info: 'AV8'}, 
      {value: 'A7', info: 'DV8'}, 
    ]
  ];

  data.parameters[1] = layers;  

  // init string '' generated by elementsettings.svelte from NaN to 0;

  onMount(()=>{
    // this may be needed to put in a $: for reactivity but seems to work anyway
 
    if(data.parameters[2] === ''){
      data.parameters[1] = ['','']
      data.parameters[2] = 1;
    } 

    //startColor = `rgb(${data.parameters[2]}, ${data.parameters[3]}, ${data.parameters[4]})`

    //alpha = data.parameters[5];

    data.parameters[0] = parameters[0].value; 

    // intensity -> A3/A7
  })

</script>

<div class="flex flex-col w-full">
  <div class="flex w-full text-white">
    <div class=" w-1/3">
      <div class="text-gray-700 text-xs">Element</div>
      <DropDownInput optionList={parameters[0]} bind:dropDownValue={data.parameters[0]}/>
    </div>
    <div class="w-1/3">
      <div class="text-gray-700 text-xs">Layer</div>
      <div class="flex justify-around my-1">
        <div class="mx-1 flex ">
          <div class="text-white mr-1">A</div>
          <input bind:group={layers} value={1} on:change={sendData} type="checkbox" class="h-6 w-6">
        </div>
        <div class="mx-1 flex ">
          <div class="text-white pr-1">B</div>
          <input bind:group={layers} value={2} on:change={sendData} type="checkbox" class="h-6 w-6">
        </div>
      </div>
    </div>

    <div class="flex w-1/3">
      <div class="px-1">
        <div class="text-gray-700 text-xs">Intensity</div>
        <DropDownInput optionList={parameters[1]} bind:dropDownValue={data.parameters[2]}/>
      </div>
    </div>
  </div>

</div>